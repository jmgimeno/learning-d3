<!DOCTYPE html>
<html>
<head>
    <title>Column graph for rhizomer</title>
    <script src="../d3/d3.v2.js" type="text/javascript"></script>
    <script src="rhizomerResults.js" type="text/javascript"></script>
</head>
<body>
    <script type="text/javascript">

        var transformValue = function(item) {
            var dataType = item.datatype,
                value = item.value;
            switch (dataType) {
                case "http://www.w3.org/2001/XMLSchema#string"  : return value;
                case "http://www.w3.org/2001/XMLSchema#integer" : return parseInt(value);
                default : return value;
            }
        };

        var rhizomer2d3 = function(data, propertyTranslator) {
            var variables = data.head.vars;
            return data.results.bindings.map(function(item) {
                var result = {};
                variables.forEach(function(v) {
                    result[propertyTranslator[v] || v] = transformValue(item[v]);
                });
                return result;
            })
        };

        var values = function(obj) {
            return Object.keys(obj).map(function(key) {
                return obj[key];
            });
        };

        var maxForProps = function(data, props) {
            var maxs = props.map(function(p) {
                return d3.max(data, function(d) {
                    return d[p];
                })
            });
            return d3.max(maxs);
        };

//        var rhizomerData = oneVariable20Values,
//            rhizomerTranslator = oneTranslator;

        var rhizomerData = twoVariables10Values,
                rhizomerTranslator = twoTranslator;

        var data = rhizomer2d3(rhizomerData, rhizomerTranslator);

        var w = 1000, h = 400, groupPadding = 0.1;

        var svg = d3.select("body").append("svg").attr("width", w).attr("height", h);

        var numProps  = values(data).length;
        var numValues = data.length;

        var yScale = d3.scale.linear()
                       .domain([0, maxForProps(data, values(rhizomerTranslator))])
                       .range([0, h]);

        var gScale = d3.scale.ordinal()
                       .domain(d3.range(data.length))
                       .rangeBands([0, w], groupPadding);

        var mkBars = function(group, gWidth, yScale, props) {
            var obj = this.datum();
            var values = props.map(function(p) {
                return obj[p];
            });
            var xScale = d3.scale.ordinal()
                    .domain(d3.range(values.length))
                    .rangeBands([0, gWidth]);
            var barColors = d3.scale.category10();
            group.selectAll("rect")
                    .data(values)
                    .enter()
                    .append("rect")
                    .attr("x", function(d, i) {
                        return xScale(i);
                    })
                    .attr("y", function(d, i) {
                        return -yScale(d);
                    })
                    .attr("width", xScale.rangeBand())
                    .attr("height", function(d, i) {
                        return yScale(d);
                    })
                    .attr("fill", function(d, i) {
                        return barColors(i);
                    })
        }

        svg.selectAll(".group")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "group")
                .attr("transform", function(d, i) {
                    return "translate(" + gScale(i) + ", " + h + ")";
                })
                .each(function(d, i) {
                    var gWidth = gScale.rangeBand();
                    var props = values(rhizomerTranslator);
                    var obj = this.__data__;
                    var vals = props.map(function(p) {
                        return obj[p];
                    });
                    var xScale = d3.scale.ordinal()
                            .domain(d3.range(vals.length))
                            .rangeBands([0, gWidth]);
                    var barColors = d3.scale.category10();
                    d3.select(this)
                            .selectAll("rect")
                            .data(vals)
                            .enter()
                            .append("rect")
                            .attr("x", function(d, i) {
                                return xScale(i);
                            })
                            .attr("y", function(d, i) {
                                return -yScale(d);
                            })
                            .attr("width", xScale.rangeBand())
                            .attr("height", function(d, i) {
                                return yScale(d);
                            })
                            .attr("fill", function(d, i) {
                                return barColors(i);
                            });
                });
    </script>
</body>
</html>