<!DOCTYPE html>
<html>
<head>
    <title>Moving Histogram</title>
    
    <script type="text/javascript" src="../d3/d3.js"></script>
    <script type="text/javascript" src="../d3/d3.time.js"></script>

    <script type="text/javascript" src="data.js"></script>
    
    <style type="text/css">

        svg {
            font: 10px sans-serif;
        }

        .bar {
            stroke: white;
            fill: steelBlue;

        }

        .axis path, .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        rect.mover {
            stroke: lightSteelBlue;
            stroke-opacity: 0.3;
            fill: lightSteelBlue;
            fill-opacity: 0.1;
        }

    </style>
</head>
<body>

    <div id="diagram"></div>

    <script type="text/javascript">

        var labels = ["uno", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve", "diez"],
            valuef = function () { return Math.random() * 40 + 30; },
            data   = labels.map(function (label) { return { label: label, value: valuef()}; });

        var margin =  {top: 20, right: 10, bottom: 20, left: 40},
            selectorHeight = 20
            width = 400 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom - selectorHeight,
            barWidth = 50;

        var numBars = Math.round(width/barWidth);

        var x = d3.scale.ordinal()
                .domain(data.slice(0,numBars).map(function (d) { return d.label; }))
                .rangeBands([0, numBars * barWidth]),
            y = d3.scale.linear()
                .domain([0, 70])
                .range([height, 0]);

        var xAxis  = d3.svg.axis().scale(x).orient("bottom"),
            yAxis  = d3.svg.axis().scale(y).orient("left");

        var svg = d3.select("#diagram").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom + selectorHeight);

        var diagram = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        diagram.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0, " + height + ")")
                .call(xAxis);

        diagram.append("g")
                .attr("class", "y axis")
                .call(yAxis);

        var bars = diagram.append("g");

        bars.selectAll("rect")
            .data(data.slice(0, numBars))
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function (d) { return x(d.label); })
            .attr("y", function (d) { return y(d.value); })
            .attr("width", x.rangeBand())
            .attr("height", function (d) { return height - y(d.value); });

        var displayed = d3.scale.linear().domain([0, data.length]).range([0, width]);

        diagram.append("rect")
            .attr("transform", "translate(0, " + (height + margin.bottom) + ")")
            .attr("class", "mover")
            .attr("x", 0)
            .attr("y", 0)
            .attr("height", selectorHeight)
            .attr("width", displayed(numBars))
            .attr("pointer-events", "all")
            .attr("cursor", "ew-resize")
            .call(d3.behavior.drag().on("drag", display));

        function display () {
            var newx = parseInt(d3.select(this).attr("x")) + d3.event.dx,
                w = parseInt(d3.select(this).attr("width")),
                first, new_data;

            if ( 0 <= newx && newx + w <= width ) {

                d3.select(this).attr("x", newx);

                first  = Math.round(displayed.invert(newx));
                new_data = data.slice(first, first + numBars);

                x.domain(new_data.map(function (d) { return d.label; }));
                diagram.select(".x.axis").call(xAxis);

                bars.selectAll("rect").remove();

                bars.selectAll("rect")
                    .data(new_data)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d) { return x(d.label); })
                    .attr("y", function (d) { return y(d.value); })
                    .attr("width", x.rangeBand())
                    .attr("height", function (d) { return height - y(d.value); });
            }
        };
    </script>
</body>
</html>